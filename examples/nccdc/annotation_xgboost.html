<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <link rel="shortcut icon" href="../../_static/logo2.png"/><!-- Generated with Sphinx 7.2.6 and Furo 2023.08.19 -->
        <title>Load data &amp; Preprocessing - united documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">united  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/logo2.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">united  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../installation.html">Installation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Installation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../getting_started.html">Get started</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Get started</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../core.html">Core modules</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../electricity/forecasting.html">Time series forecasting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basic_motions/classification.html">Time series classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../human_activity_recognition/annotation.html">Time series annotation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.timeseries.TimeSeriesDataset.html">TimeSeriesDataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.timeseries.SensorTimeSeriesDataset.html">SensorTimeSeriesDataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.encoders.NaNLabelEncoder.html">NaNLabelEncoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.encoders.TorchStandardScaler.html">TorchStandardScaler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.imputers.BackwardFillingImputer.html">BackwardFillingImputer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.imputers.ForwardFillingImputer.html">ForwardFillingImputer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.imputers.ConstantFillingImputer.html">ConstantFillingImputer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.imputers.InterpolateImputer.html">InterpolateImputer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.imputers.TryHardImputer.html">TryHardImputer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.imputers.BaseTransformer.html">BaseTransformer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.samplers.BySimilarLengthBatchSampler.html">BySimilarLengthBatchSampler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.data.timeseries.DatasetProperties.html">DatasetProperties</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.forecasting.LSTMForecaster.html">LSTMForecaster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.forecasting.GraphICForecaster.html">GraphICForecaster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.forecasting.EranForecaster.html">EranForecaster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.classification.LSTMClassifier.html">LSTMClassifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.classification.GraphICClassifier.html">GraphICClassifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.classification.EranClassifier.html">EranClassifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.annotation.LSTMAnnotation.html">LSTMAnnotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.annotation.TransformerAnnotation.html">TransformerAnnotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.BaseModule.html">BaseModule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.BaseRNNForecaster.html">BaseRNNForecaster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.Predictor.html">Predictor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.LinearPredictor.html">LinearPredictor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.SelfAttentionPredictor.html">SelfAttentionPredictor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.PredictorType.html">PredictorType</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.EranEncoder.html">EranEncoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.EncoderDecoderMixins.html">EncoderDecoderMixins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.DecoderOnlyMixins.html">DecoderOnlyMixins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.EncoderOnlyMixins.html">EncoderOnlyMixins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.BaseGraphIC.html">BaseGraphIC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.models.base.BaseEran.html">BaseEran</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.SMAPE.html">SMAPE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.RSE.html">RSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.MSE.html">MSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.RMSE.html">RMSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.MAE.html">MAE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.MAPE.html">MAPE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.Accuracy.html">Accuracy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.CrossEntropyLoss.html">CrossEntropyLoss</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/united.metrics.BaseMetric.html">BaseMetric</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">icecream</span> <span class="kn">import</span> <span class="n">ic</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="n">LOCALS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NVD4K9M6K4&#39;</span><span class="p">,</span> <span class="s1">&#39;x1&#39;</span><span class="p">]</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="n">IS_LOCAL</span> <span class="o">=</span> <span class="n">hostname</span> <span class="ow">in</span> <span class="n">LOCALS</span>
<span class="k">def</span> <span class="nf">view_df</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">reset_option</span><span class="p">(</span><span class="s2">&quot;max_columns&quot;</span><span class="p">)</span>

<span class="n">impact_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./data/&#39;</span><span class="p">)</span>
<span class="n">processed_data_path</span> <span class="o">=</span> <span class="n">impact_path</span> <span class="o">/</span> <span class="s1">&#39;processed-data.csv&#39;</span>
<span class="n">label_data_path</span> <span class="o">=</span> <span class="n">impact_path</span> <span class="o">/</span> <span class="s1">&#39;label-data.csv&#39;</span>
</pre></div>
</div>
</div>
<section id="Load-data-&amp;-Preprocessing">
<h1>Load data &amp; Preprocessing<a class="headerlink" href="#Load-data-&-Preprocessing" title="Link to this heading">#</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="c1"># nrows= 100000 if IS_LOCAL else None</span>
<span class="c1"># n = 19433497-1</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">19433497</span>
<span class="n">s</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="c1"># IS_LOCAL = False</span>

<span class="n">skip</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="o">-</span><span class="n">s</span><span class="p">))</span> <span class="k">if</span> <span class="n">IS_LOCAL</span> <span class="k">else</span> <span class="kc">None</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">processed_data_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;protocol&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rootId&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;source.port&#39;: str,</span>
        <span class="c1"># &#39;destination.port&#39;: str,</span>
    <span class="p">},</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="n">skip</span> <span class="k">if</span> <span class="n">IS_LOCAL</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># nrows=s,</span>
<span class="p">)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">label_data_path</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
    <span class="c1"># dtype={</span>
    <span class="c1">#     &#39;is_multicast&#39;: bool,</span>
    <span class="c1">#     &#39;is_private&#39;: bool,</span>
    <span class="c1">#     &#39;is_global&#39;: bool,</span>
    <span class="c1">#     &#39;is_unspecified&#39;: bool,</span>
    <span class="c1">#     &#39;is_reserved&#39;: bool,</span>
    <span class="c1">#     &#39;is_loopback&#39;: bool,</span>
    <span class="c1">#     &#39;is_link_local&#39;: bool</span>
    <span class="c1"># },</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="n">skip</span> <span class="k">if</span> <span class="n">IS_LOCAL</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># nrows=s,</span>
<span class="p">)</span>

<span class="c1"># data = pd.concat([input.drop([&#39;source.ip&#39;], axis=1), label], axis=1)</span>
<span class="c1"># data = input.dr</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;source.ip&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># if IS_LOCAL:</span>
<span class="c1">#     data = data.sample(10000)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/q.nguyen/opt/anaconda3/envs/graphic/lib/python3.9/site-packages/IPython/core/interactiveshell.py:3460: DtypeWarning: Columns (21,26) have mixed types.Specify dtype option on import or set low_memory=False.
  exec(code_obj, self.user_global_ns, self.user_ns)
/Users/q.nguyen/opt/anaconda3/envs/graphic/lib/python3.9/site-packages/IPython/core/interactiveshell.py:3460: DtypeWarning: Columns (19) have mixed types.Specify dtype option on import or set low_memory=False.
  exec(code_obj, self.user_global_ns, self.user_ns)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # convert column that its values are array as string type to native python array</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="n">data</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">to_python_array</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Failed: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>


<span class="n">array_str_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;dns.host&#39;</span><span class="p">]</span>
<span class="n">label_array_str_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;critservice&#39;</span><span class="p">,</span> <span class="s1">&#39;dns_lookup_alias&#39;</span><span class="p">]</span>
<span class="c1"># for col in array_str_cols:</span>
<span class="c1">#     # data[col] = data[col].apply(to_python_array)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">timestamp_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;firstPacket&#39;</span><span class="p">,</span> <span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">timestamp_columns</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;firstPacket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_from_start_to_last_packet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_from_start_to_first_packet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;firstPacket&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>


<span class="c1"># g = data.groupby([&#39;destination.ip&#39;, &#39;destination.port&#39;], as_index=False)</span>

<span class="c1"># def add_groupwise_time_idx(in_: pd.DataFrame):</span>
<span class="c1">#     idx = pd.DataFrame(data={&#39;g_time_idx&#39;: list(range(in_.shape[0]))}, dtype=np.int64)</span>

<span class="c1">#     out = pd.concat([</span>
<span class="c1">#         in_.reset_index(drop=True).sort_values(by=&#39;time_idx&#39;),</span>
<span class="c1">#         idx.reset_index(drop=True)</span>
<span class="c1">#     ], axis=1)</span>
<span class="c1">#     return out</span>

<span class="c1"># data = g.apply(add_groupwise_time_idx)</span>


<span class="n">data</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
<span class="c1"># data[&#39;day&#39;] = data[&#39;lastPacket&#39;].day</span>
<span class="c1"># data[&#39;day_of_week&#39;] = data[&#39;lastPacket&#39;].dayofweek</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;microsecond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span>

<span class="n">CYCLIC_COLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;hour&#39;</span><span class="p">,</span>
    <span class="s1">&#39;minute&#39;</span><span class="p">,</span>
    <span class="s1">&#39;second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;microsecond&#39;</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CYCLIC_COLS</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_sin&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_cos&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>


<span class="n">data</span><span class="p">[</span><span class="s1">&#39;has_cert&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cert&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;has_dns_host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dns.host&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>


<span class="c1"># data[&#39;destination.port.s&#39;] = data[&#39;destination.port&#39;].astype(str)</span>

<span class="c1"># data.rename(</span>
<span class="c1">#     columns={</span>
<span class="c1">#         name: name.replace(&#39;.&#39;, &#39;_&#39;) for name in list(data.columns)</span>
<span class="c1">#     },</span>
<span class="c1">#     inplace=True</span>
<span class="c1"># )</span>
<span class="c1"># data.replace(&#39;&#39;, np.nan)</span>

<span class="c1"># testing_cutoff = pd.to_datetime(&#39;2016-04-22 21:00:00&#39;)</span>
<span class="c1"># testing_df = data[data[&#39;lastPacket&#39;] &gt; testing_cutoff]</span>


<span class="c1"># validation_cutoff = pd.to_datetime(&#39;2016-04-22 20:30:00&#39;)</span>
<span class="c1"># validation_df = data[(data[&#39;lastPacket&#39;] &gt; validation_cutoff) &amp; (data[&#39;lastPacket&#39;] &lt; testing_cutoff)]</span>

<span class="c1"># training_df = data[data[&#39;lastPacket&#39;] &lt;= validation_cutoff]</span>
<span class="k">if</span> <span class="n">IS_LOCAL</span><span class="p">:</span>
    <span class="n">view_df</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">display</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>firstPacket</th>
      <th>lastPacket</th>
      <th>ipProtocol</th>
      <th>protocol</th>
      <th>rootId</th>
      <th>totDataBytes</th>
      <th>client.bytes</th>
      <th>server.bytes</th>
      <th>source.ip</th>
      <th>source.port</th>
      <th>destination.ip</th>
      <th>destination.port</th>
      <th>network.packets</th>
      <th>source.packets</th>
      <th>destination.packets</th>
      <th>network.bytes</th>
      <th>source.bytes</th>
      <th>destination.bytes</th>
      <th>node</th>
      <th>http.uri</th>
      <th>source.geo.country_iso_code</th>
      <th>destination.geo.country_iso_code</th>
      <th>dns.host</th>
      <th>cert</th>
      <th>irc.channel</th>
      <th>http.xffGEO</th>
      <th>time_idx</th>
      <th>time_from_start_to_last_packet</th>
      <th>time_from_start_to_first_packet</th>
      <th>hour</th>
      <th>minute</th>
      <th>second</th>
      <th>microsecond</th>
      <th>hour_sin</th>
      <th>hour_cos</th>
      <th>minute_sin</th>
      <th>minute_cos</th>
      <th>second_sin</th>
      <th>second_cos</th>
      <th>microsecond_sin</th>
      <th>microsecond_cos</th>
      <th>has_cert</th>
      <th>has_dns_host</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2016-04-22 14:00:00.006</td>
      <td>2016-04-22 14:24:00.122</td>
      <td>6</td>
      <td>[tcp]</td>
      <td>160422-3gNaohIY_a9CmIgI7Hkjn6eF</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>192.168.223.11</td>
      <td>902</td>
      <td>192.168.223.177</td>
      <td>49858</td>
      <td>4685</td>
      <td>2295</td>
      <td>2390</td>
      <td>1885844</td>
      <td>1610152</td>
      <td>275692</td>
      <td>cma-arkime</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1440116</td>
      <td>1440.116</td>
      <td>0.000</td>
      <td>14</td>
      <td>24</td>
      <td>0</td>
      <td>122000</td>
      <td>-6.310879e-01</td>
      <td>-0.775711</td>
      <td>0.552800</td>
      <td>-0.833314</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.694206</td>
      <td>0.719777</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2016-04-22 14:00:00.006</td>
      <td>2016-04-22 14:40:00.122</td>
      <td>6</td>
      <td>[tcp]</td>
      <td>160422-3gNaohIY_a9CmIgI7Hkjn6eF</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>192.168.223.11</td>
      <td>902</td>
      <td>192.168.223.177</td>
      <td>49858</td>
      <td>86</td>
      <td>39</td>
      <td>47</td>
      <td>14071</td>
      <td>8640</td>
      <td>5431</td>
      <td>cma-arkime</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2400116</td>
      <td>2400.116</td>
      <td>0.000</td>
      <td>14</td>
      <td>40</td>
      <td>0</td>
      <td>122000</td>
      <td>-6.310879e-01</td>
      <td>-0.775711</td>
      <td>-0.899312</td>
      <td>-0.437307</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.694206</td>
      <td>0.719777</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2016-04-22 14:00:00.062</td>
      <td>2016-04-22 14:02:02.720</td>
      <td>6</td>
      <td>[tcp]</td>
      <td>160422-3gMBN_bwBMBOIaYvGs-w6P3R</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>91.189.88.148</td>
      <td>80</td>
      <td>10.222.83.2</td>
      <td>50340</td>
      <td>10000</td>
      <td>5860</td>
      <td>4140</td>
      <td>9165504</td>
      <td>8872040</td>
      <td>293464</td>
      <td>cma-arkime</td>
      <td>NaN</td>
      <td>GB</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>122714</td>
      <td>122.714</td>
      <td>0.056</td>
      <td>14</td>
      <td>2</td>
      <td>2</td>
      <td>720000</td>
      <td>-6.310879e-01</td>
      <td>-0.775711</td>
      <td>0.211383</td>
      <td>0.977403</td>
      <td>0.211383</td>
      <td>0.977403</td>
      <td>-0.983126</td>
      <td>-0.182931</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2016-04-22 14:00:00.062</td>
      <td>2016-04-22 14:04:17.049</td>
      <td>6</td>
      <td>[tcp]</td>
      <td>160422-3gMBN_bwBMBOIaYvGs-w6P3R</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>91.189.88.148</td>
      <td>80</td>
      <td>10.222.83.2</td>
      <td>50340</td>
      <td>10000</td>
      <td>5792</td>
      <td>4208</td>
      <td>9073848</td>
      <td>8769088</td>
      <td>304760</td>
      <td>cma-arkime</td>
      <td>NaN</td>
      <td>GB</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>257043</td>
      <td>257.043</td>
      <td>0.056</td>
      <td>14</td>
      <td>4</td>
      <td>17</td>
      <td>49000</td>
      <td>-6.310879e-01</td>
      <td>-0.775711</td>
      <td>0.413212</td>
      <td>0.910635</td>
      <td>0.971430</td>
      <td>-0.237327</td>
      <td>0.303329</td>
      <td>0.952886</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>49</th>
      <td>2016-04-22 14:00:00.062</td>
      <td>2016-04-22 14:12:34.574</td>
      <td>6</td>
      <td>[tcp]</td>
      <td>160422-3gMBN_bwBMBOIaYvGs-w6P3R</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>91.189.88.148</td>
      <td>80</td>
      <td>10.222.83.2</td>
      <td>50340</td>
      <td>10000</td>
      <td>5819</td>
      <td>4181</td>
      <td>9110516</td>
      <td>8809966</td>
      <td>300550</td>
      <td>cma-arkime</td>
      <td>NaN</td>
      <td>GB</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>754568</td>
      <td>754.568</td>
      <td>0.056</td>
      <td>14</td>
      <td>12</td>
      <td>34</td>
      <td>574000</td>
      <td>-6.310879e-01</td>
      <td>-0.775711</td>
      <td>0.957422</td>
      <td>0.288692</td>
      <td>-0.461093</td>
      <td>-0.887352</td>
      <td>-0.451607</td>
      <td>-0.892217</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>19433444</th>
      <td>2016-04-22 23:28:25.445</td>
      <td>2016-04-22 23:28:25.445</td>
      <td>6</td>
      <td>[tcp]</td>
      <td>&lt;NA&gt;</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>10.180.108.77</td>
      <td>61115</td>
      <td>10.10.10.205</td>
      <td>9220</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>60</td>
      <td>60</td>
      <td>0</td>
      <td>cma-arkime</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>34105439</td>
      <td>34105.439</td>
      <td>34105.439</td>
      <td>23</td>
      <td>28</td>
      <td>25</td>
      <td>445000</td>
      <td>-2.449294e-16</td>
      <td>1.000000</td>
      <td>0.159063</td>
      <td>-0.987268</td>
      <td>0.461093</td>
      <td>-0.887352</td>
      <td>0.336103</td>
      <td>-0.941825</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>19433454</th>
      <td>2016-04-22 23:28:25.459</td>
      <td>2016-04-22 23:28:25.459</td>
      <td>6</td>
      <td>[tcp]</td>
      <td>&lt;NA&gt;</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>10.180.108.77</td>
      <td>59578</td>
      <td>172.16.50.205</td>
      <td>16018</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>60</td>
      <td>60</td>
      <td>0</td>
      <td>cma-arkime</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>34105453</td>
      <td>34105.453</td>
      <td>34105.453</td>
      <td>23</td>
      <td>28</td>
      <td>25</td>
      <td>459000</td>
      <td>-2.449294e-16</td>
      <td>1.000000</td>
      <td>0.159063</td>
      <td>-0.987268</td>
      <td>0.461093</td>
      <td>-0.887352</td>
      <td>0.251978</td>
      <td>-0.967733</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>19433458</th>
      <td>2016-04-22 23:28:25.474</td>
      <td>2016-04-22 23:28:25.477</td>
      <td>6</td>
      <td>[http tcp]</td>
      <td>&lt;NA&gt;</td>
      <td>483</td>
      <td>367</td>
      <td>116</td>
      <td>172.16.20.203</td>
      <td>57823</td>
      <td>10.200.97.3</td>
      <td>80</td>
      <td>11</td>
      <td>6</td>
      <td>5</td>
      <td>1163</td>
      <td>727</td>
      <td>436</td>
      <td>cma-arkime</td>
      <td>['10.200.97.3/j.ad']</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>34105471</td>
      <td>34105.471</td>
      <td>34105.468</td>
      <td>23</td>
      <td>28</td>
      <td>25</td>
      <td>477000</td>
      <td>-2.449294e-16</td>
      <td>1.000000</td>
      <td>0.159063</td>
      <td>-0.987268</td>
      <td>0.461093</td>
      <td>-0.887352</td>
      <td>0.141041</td>
      <td>-0.990004</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>19433494</th>
      <td>2016-04-22 23:28:25.645</td>
      <td>2016-04-22 23:28:25.650</td>
      <td>6</td>
      <td>[http tcp]</td>
      <td>&lt;NA&gt;</td>
      <td>487</td>
      <td>371</td>
      <td>116</td>
      <td>172.16.20.203</td>
      <td>57826</td>
      <td>10.200.168.39</td>
      <td>80</td>
      <td>9</td>
      <td>5</td>
      <td>4</td>
      <td>1043</td>
      <td>671</td>
      <td>372</td>
      <td>cma-arkime</td>
      <td>['10.200.168.39/dpixel']</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>34105644</td>
      <td>34105.644</td>
      <td>34105.639</td>
      <td>23</td>
      <td>28</td>
      <td>25</td>
      <td>650000</td>
      <td>-2.449294e-16</td>
      <td>1.000000</td>
      <td>0.159063</td>
      <td>-0.987268</td>
      <td>0.461093</td>
      <td>-0.887352</td>
      <td>-0.811413</td>
      <td>-0.584473</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>19433495</th>
      <td>2016-04-22 23:28:25.645</td>
      <td>2016-04-22 23:28:25.650</td>
      <td>6</td>
      <td>[http tcp]</td>
      <td>&lt;NA&gt;</td>
      <td>704</td>
      <td>555</td>
      <td>149</td>
      <td>172.16.60.205</td>
      <td>1672</td>
      <td>10.200.251.80</td>
      <td>80</td>
      <td>9</td>
      <td>5</td>
      <td>4</td>
      <td>1252</td>
      <td>851</td>
      <td>401</td>
      <td>cma-arkime</td>
      <td>['10.200.251.80/images/fikfcpnnoodlomkboaoocin...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>[]</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>34105644</td>
      <td>34105.644</td>
      <td>34105.639</td>
      <td>23</td>
      <td>28</td>
      <td>25</td>
      <td>650000</td>
      <td>-2.449294e-16</td>
      <td>1.000000</td>
      <td>0.159063</td>
      <td>-0.987268</td>
      <td>0.461093</td>
      <td>-0.887352</td>
      <td>-0.811413</td>
      <td>-0.584473</td>
      <td>False</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>1000000 rows  43 columns</p>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 1000000 entries, 1 to 19433495
Data columns (total 43 columns):
 #   Column                            Non-Null Count    Dtype
---  ------                            --------------    -----
 0   firstPacket                       1000000 non-null  datetime64[ns]
 1   lastPacket                        1000000 non-null  datetime64[ns]
 2   ipProtocol                        1000000 non-null  int64
 3   protocol                          1000000 non-null  string
 4   rootId                            6031 non-null     string
 5   totDataBytes                      1000000 non-null  int64
 6   client.bytes                      1000000 non-null  int64
 7   server.bytes                      1000000 non-null  int64
 8   source.ip                         1000000 non-null  object
 9   source.port                       1000000 non-null  int64
 10  destination.ip                    1000000 non-null  object
 11  destination.port                  1000000 non-null  int64
 12  network.packets                   1000000 non-null  int64
 13  source.packets                    1000000 non-null  int64
 14  destination.packets               1000000 non-null  int64
 15  network.bytes                     1000000 non-null  int64
 16  source.bytes                      1000000 non-null  int64
 17  destination.bytes                 1000000 non-null  int64
 18  node                              1000000 non-null  object
 19  http.uri                          68941 non-null    object
 20  source.geo.country_iso_code       5130 non-null     object
 21  destination.geo.country_iso_code  57473 non-null    object
 22  dns.host                          1000000 non-null  object
 23  cert                              16287 non-null    object
 24  irc.channel                       0 non-null        float64
 25  http.xffGEO                       824 non-null      object
 26  time_idx                          1000000 non-null  int64
 27  time_from_start_to_last_packet    1000000 non-null  float64
 28  time_from_start_to_first_packet   1000000 non-null  float64
 29  hour                              1000000 non-null  int64
 30  minute                            1000000 non-null  int64
 31  second                            1000000 non-null  int64
 32  microsecond                       1000000 non-null  int64
 33  hour_sin                          1000000 non-null  float64
 34  hour_cos                          1000000 non-null  float64
 35  minute_sin                        1000000 non-null  float64
 36  minute_cos                        1000000 non-null  float64
 37  second_sin                        1000000 non-null  float64
 38  second_cos                        1000000 non-null  float64
 39  microsecond_sin                   1000000 non-null  float64
 40  microsecond_cos                   1000000 non-null  float64
 41  has_cert                          1000000 non-null  bool
 42  has_dns_host                      1000000 non-null  bool
dtypes: bool(2), datetime64[ns](2), float64(11), int64(17), object(9), string(2)
memory usage: 322.3+ MB
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
None
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 1000000 entries, 1 to 19433495
Data columns (total 19 columns):
 #   Column            Non-Null Count   Dtype
---  ------            --------------   -----
 0   is_multicast      999315 non-null  object
 1   is_private        999315 non-null  object
 2   is_global         999315 non-null  object
 3   is_unspecified    999315 non-null  object
 4   is_reserved       999315 non-null  object
 5   is_loopback       999315 non-null  object
 6   is_link_local     999315 non-null  object
 7   blue_team         127885 non-null  object
 8   facility          681958 non-null  object
 9   service           999315 non-null  object
 10  critservice       999315 non-null  object
 11  hostname          306029 non-null  object
 12  dns_alias         235391 non-null  object
 13  hardware          306029 non-null  object
 14  opsys             310198 non-null  object
 15  sharedinfra       6400 non-null    object
 16  is_red_team       999315 non-null  object
 17  dns_lookup_host   3592 non-null    object
 18  dns_lookup_alias  999315 non-null  object
dtypes: object(19)
memory usage: 152.6+ MB
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
None
</pre></div></div>
</div>
</section>
<section id="Feature-Engineering">
<h1>Feature Engineering<a class="headerlink" href="#Feature-Engineering" title="Link to this heading">#</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CATEGORICAL_COLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &#39;rootId&#39;,</span>
    <span class="s1">&#39;ipProtocol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;protocol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source.ip&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source.port&#39;</span><span class="p">,</span>
    <span class="s1">&#39;destination.ip&#39;</span><span class="p">,</span>
    <span class="s1">&#39;destination.port&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;node&#39;,</span>
    <span class="c1"># &#39;http.uri&#39;,</span>
    <span class="s1">&#39;source.geo.country_iso_code&#39;</span><span class="p">,</span>
    <span class="s1">&#39;destination.geo.country_iso_code&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;dns.host&#39;,</span>
    <span class="s1">&#39;has_dns_host&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;cert&#39;,</span>
    <span class="c1"># &#39;irc.channel&#39;,</span>
    <span class="c1"># &#39;http.xffGEO&#39;,</span>
    <span class="s1">&#39;has_cert&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">COUNTRY_ISO_CODE_COLS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;source.geo.country_iso_code&#39;</span><span class="p">,</span> <span class="s1">&#39;destination.geo.country_iso_code&#39;</span><span class="p">]</span>

<span class="c1"># array_str_cols = [&#39;protocol&#39;, &#39;dns.host&#39;, &#39;service&#39;, &#39;critservice&#39;, &#39;dns_lookup_alias&#39;]</span>

<span class="n">NUMERIC_COLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;totDataBytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;client.bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;server.bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;network.packets&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source.packets&#39;</span><span class="p">,</span>
    <span class="s1">&#39;destination.packets&#39;</span><span class="p">,</span>
    <span class="s1">&#39;network.bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source.bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;destination.bytes&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">LABEL_BINARY_COLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &#39;is_multicast&#39;,</span>
    <span class="s1">&#39;is_private&#39;</span><span class="p">,</span><span class="s1">&#39;is_global&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_unspecified&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;is_reserved&#39;,</span>
    <span class="c1"># &#39;is_loopback&#39;, # only 6 positive</span>
    <span class="s1">&#39;is_link_local&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_red_team&#39;</span><span class="p">,</span>

<span class="p">]</span>
<span class="n">LABEL_MULTI_CLASSES_COLS</span> <span class="o">=</span><span class="p">[</span>
    <span class="s1">&#39;blue_team&#39;</span><span class="p">,</span><span class="s1">&#39;facility&#39;</span><span class="p">,</span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;critservice&#39;,</span>
    <span class="s1">&#39;hostname&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dns_alias&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hardware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;opsys&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;sharedinfra&#39;,</span>
    <span class="c1"># &#39;dns_lookup_host&#39;,</span>
    <span class="c1"># &#39;dns_lookup_alias&#39;</span>
<span class="p">]</span>

<span class="c1"># cyclic_cols = [</span>
<span class="c1">#     &#39;hour&#39;,</span>
<span class="c1">#     &#39;minute&#39;,</span>
<span class="c1">#     &#39;second&#39;,</span>
<span class="c1">#     &#39;microsecond&#39;</span>
<span class="c1"># ]</span>


<span class="n">new_cyclic_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">c</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CYCLIC_COLS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_sin&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_cos&#39;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">NUMERIC_COLS</span> <span class="o">+=</span> <span class="n">new_cyclic_cols</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLS</span><span class="p">:</span>
    <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Train/Test-Split">
<h1>Train/Test Split<a class="headerlink" href="#Train/Test-Split" title="Link to this heading">#</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="n">check_is_fitted</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">united.data.encoders</span> <span class="kn">import</span> <span class="n">NaNLabelEncoder</span>
<span class="kn">from</span> <span class="nn">united.data.imputers</span> <span class="kn">import</span> <span class="n">BackwardFillingImputer</span><span class="p">,</span> <span class="n">ForwardFillingImputer</span><span class="p">,</span> <span class="n">InterpolateImputer</span><span class="p">,</span> <span class="n">TryHardImputer</span><span class="p">,</span> <span class="n">ConstantFillingImputer</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="n">RANDOM_STATE</span> <span class="o">=</span> <span class="mi">42</span>

<span class="k">def</span> <span class="nf">split_by_time</span><span class="p">(</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">validation_cutoff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2016-04-22 20:30:00&#39;</span><span class="p">),</span>
        <span class="n">testing_cutoff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2016-04-22 21:00:00&#39;</span><span class="p">)</span>
    <span class="p">):</span>
    <span class="n">mask_train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">testing_cutoff</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask_train</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">mask_train</span><span class="p">]</span>

    <span class="n">mask_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">validation_cutoff</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">testing_cutoff</span><span class="p">)</span>
    <span class="n">X_val</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask_val</span><span class="p">]</span>
    <span class="n">y_val</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">mask_val</span><span class="p">]</span>

    <span class="n">mask_train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastPacket&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">validation_cutoff</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask_train</span><span class="p">]</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">mask_train</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">split_by_row</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">val_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">X_train_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">RANDOM_STATE</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_train_val</span><span class="p">,</span> <span class="n">y_train_val</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">val_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>


<span class="c1"># -----------------------------</span>
<span class="c1"># SPLIT DATA</span>

<span class="k">def</span> <span class="nf">is_numeric</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine if series is numeric or not. Will also return True if series is a categorical type with</span>
<span class="sd">    underlying integers.</span>

<span class="sd">    Args:</span>
<span class="sd">        y (pd.Series): series for which to carry out assessment</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if series is numeric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s2">&quot;bcif&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">)</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="s2">&quot;bcif&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">acquire_train_val_test_splits</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span>
    <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">lagged_features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">trailing_window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">split_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">split_by_time</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># xxx</span>
    <span class="n">target_mask</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">target_mask</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">target_mask</span><span class="p">]</span>

    <span class="c1"># adding lagged features:</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;destination.ip&#39;</span><span class="p">,</span>
        <span class="s1">&#39;destination.port&#39;</span>
    <span class="p">]</span>
    <span class="n">add_lagged_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lagged_features</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trailing_window_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">])</span>
    <span class="c1"># ic(add_lagged_features)</span>
    <span class="n">lag_mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">add_lagged_features</span><span class="p">:</span>
        <span class="n">lagged_features</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">lagged_features</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">lagged_features</span><span class="p">])</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">lags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">lagged_features</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trailing_window_size</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">shifted</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
                <span class="c1"># lagged_name = f&quot;lagged_{feature}_{window}&quot;</span>
                <span class="n">lagged_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">__lagged__</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">lags</span><span class="p">[</span><span class="n">lagged_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">shifted</span>
                <span class="n">lag_mapping</span><span class="p">[</span><span class="n">lagged_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="n">lags_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">lags_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># assign column type (numeric or categorical) for extra lagged features</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">lags_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">org_col</span> <span class="o">=</span> <span class="n">lag_mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">org_col</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLS</span><span class="p">:</span>
                <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

    <span class="n">target_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">target_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">split_fn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">add_lagged_features</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">lags_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">X_val</span> <span class="o">=</span> <span class="n">X_val</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">target_encoder</span>

<span class="k">def</span> <span class="nf">feature_to_lag_name</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">__lagged__</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">lag_name_to_feature_window</span><span class="p">(</span><span class="n">lag_name</span><span class="p">):</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__lagged__&#39;</span><span class="p">,</span> <span class="n">lag_name</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Training">
<h1>Training<a class="headerlink" href="#Training" title="Link to this heading">#</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xgboost</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="k">def</span> <span class="nf">train_xgboost</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">xgb_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;tree_method&quot;</span><span class="p">:</span> <span class="s2">&quot;hist&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;n_estimators&quot;: 32,</span>
        <span class="c1"># &quot;colsample_bylevel&quot;: 0.7,</span>
    <span class="p">}</span>

    <span class="n">predictor</span> <span class="o">=</span> <span class="n">xgboost</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span>
        <span class="o">**</span><span class="n">xgb_params</span><span class="p">,</span>
        <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;auc&#39;</span><span class="p">,</span>
        <span class="n">enable_categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">max_cat_to_onehot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">predictor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
        <span class="n">eval_set</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span>
            <span class="c1"># (X_train, y_train)</span>
        <span class="p">],</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">predictor</span>


<span class="k">def</span> <span class="nf">eval_binary_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">target_encoder</span><span class="p">:</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">y_proba_preds</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">y_preds</span> <span class="o">=</span> <span class="n">y_proba_preds</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba_preds</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">)</span>
    <span class="n">bal_accuracy</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">)</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba_preds</span><span class="p">)</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">)</span>
    <span class="n">classification_report</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="n">target_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;AUC: </span><span class="si">{</span><span class="n">auc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Balance Accuracy: </span><span class="si">{</span><span class="n">bal_accuracy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix: &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auc</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">bal_accuracy</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span>

<span class="k">def</span> <span class="nf">plot_roc_curve</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="n">y_proba_preds</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba_preds</span><span class="p">)</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba_preds</span><span class="p">)</span>
    <span class="c1">#create ROC curve</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span><span class="n">tpr</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;target_col - AUC=</span><span class="si">{</span><span class="n">auc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">eval_multi_class_model</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">target_encoder</span><span class="p">:</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">multi_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
    <span class="n">y_proba_preds</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">multi_class</span><span class="p">:</span>
        <span class="n">y_preds</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_proba_preds</span> <span class="o">=</span> <span class="n">y_proba_preds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">y_preds</span> <span class="o">=</span> <span class="n">y_proba_preds</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_proba_preds</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovo&#39;</span> <span class="k">if</span> <span class="n">multi_class</span> <span class="k">else</span> <span class="s1">&#39;raise&#39;</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">)</span>
    <span class="n">bal_accuracy</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">balanced_accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">)</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">)</span>
    <span class="n">classification_report</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="n">target_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;AUC: </span><span class="si">{</span><span class="n">auc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Balance Accuracy: </span><span class="si">{</span><span class="n">bal_accuracy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix: &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
        <span class="c1"># metrics.ConfusionMatrixDisplay()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Classification Report:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auc</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">bal_accuracy</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span>


<span class="k">def</span> <span class="nf">get_feature_importance</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
    <span class="c1"># display(d)</span>
    <span class="n">sorted_d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature important - Top </span><span class="si">{</span><span class="n">topk</span><span class="si">}</span><span class="s2"> Features:&quot;</span><span class="p">)</span>
        <span class="n">topk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">topk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_d</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sorted_d</span><span class="p">[:</span><span class="n">topk</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sorted_d</span>



<span class="k">def</span> <span class="nf">run_full_pipeline</span><span class="p">(</span>
    <span class="n">target_col</span><span class="p">,</span> <span class="n">split_fn</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span><span class="n">NUMERIC_COLS</span><span class="o">+</span><span class="n">CATEGORICAL_COLS</span><span class="p">,</span>
    <span class="n">lagged_features</span><span class="o">=</span><span class="n">NUMERIC_COLS</span><span class="p">,</span>
    <span class="n">drop_source_ip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">drop_destination_ip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">trailing_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">train_verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">print_result</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="c1"># features = numeric_cols + categorical_cols</span>
    <span class="c1"># lagged_features = numeric_cols</span>
    <span class="c1"># ic(features)</span>
    <span class="c1"># ic(lagged_features)</span>
    <span class="n">to_remove_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">drop_source_ip</span><span class="p">:</span>
        <span class="n">to_remove_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;source.ip&#39;</span><span class="p">,</span> <span class="s1">&#39;source.port&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">drop_destination_ip</span><span class="p">:</span>
        <span class="n">to_remove_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;destination.ip&#39;</span><span class="p">,</span> <span class="s1">&#39;destination.port&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_remove_features</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lagged_features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>


    <span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">target_encoder</span> <span class="o">=</span> <span class="n">acquire_train_val_test_splits</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span>
        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">lagged_features</span><span class="o">=</span><span class="n">lagged_features</span><span class="p">,</span>
        <span class="n">trailing_window_size</span><span class="o">=</span><span class="n">trailing_window</span><span class="p">,</span>
        <span class="n">split_fn</span><span class="o">=</span><span class="n">split_fn</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Features: &#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Target Name: &#39;</span><span class="p">,</span> <span class="n">target_col</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train size: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Val size: </span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test size: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total classes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span><span class="si">}</span><span class="s2">, Classes: </span><span class="si">{</span><span class="n">target_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">target_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">))]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">predictor</span> <span class="o">=</span> <span class="n">train_xgboost</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">train_verbose</span><span class="p">)</span>

    <span class="n">eval_fn</span> <span class="o">=</span> <span class="n">eval_multi_class_model</span>
    <span class="n">auc</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">bal_accuracy</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span> <span class="o">=</span> <span class="n">eval_fn</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">target_encoder</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">print_result</span><span class="p">)</span>
    <span class="n">feature_importances</span> <span class="o">=</span> <span class="n">get_feature_importance</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">print_result</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auc</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">bal_accuracy</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">feature_importances</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Generate-report">
<h1>Generate report<a class="headerlink" href="#Generate-report" title="Link to this heading">#</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="n">FEATURES</span> <span class="o">=</span> <span class="n">NUMERIC_COLS</span> <span class="o">+</span> <span class="n">CATEGORICAL_COLS</span>
<span class="n">LAGGED_FEATURES</span> <span class="o">=</span> <span class="n">NUMERIC_COLS</span> <span class="o">+</span> <span class="n">CATEGORICAL_COLS</span>

<span class="c1"># drop_source_ips = [False, True]</span>
<span class="c1"># drop_destination_ips = [False, True]</span>
<span class="c1"># split_fns = [split_by_time, split_by_row]</span>
<span class="c1"># target_cols = label_binary_cols + label_multi_classes_cols</span>
<span class="c1"># trailing_window_sizes = [0, 1, 5, 10, 20]</span>

<span class="n">drop_source_ips</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
<span class="n">drop_destination_ips</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
<span class="n">split_fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">split_by_time</span><span class="p">]</span>
<span class="n">target_cols</span> <span class="o">=</span>  <span class="n">LABEL_MULTI_CLASSES_COLS</span>
<span class="n">trailing_window_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>


<span class="c1"># drop_source_ips = [True]</span>
<span class="c1"># drop_destination_ips = [True]</span>
<span class="c1"># split_fns = [split_by_time]</span>
<span class="c1"># target_cols = label_binary_cols + label_multi_classes_cols; target_cols = target_cols[:1]</span>
<span class="c1"># trailing_window_sizes = [0, 5]</span>

<span class="c1"># Make sure data and label are sorted: combine =&gt; sort =&gt; split</span>
<span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;time_idx&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>

<span class="n">trials</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">target_col</span> <span class="ow">in</span> <span class="n">target_cols</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">drop_source_ip</span> <span class="ow">in</span> <span class="n">drop_source_ips</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">drop_destination_ip</span> <span class="ow">in</span> <span class="n">drop_destination_ips</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">split_fn</span> <span class="ow">in</span> <span class="n">split_fns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">trailing_w</span> <span class="ow">in</span> <span class="n">trailing_window_sizes</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="o">*</span><span class="mi">120</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Classification Report for </span><span class="si">{</span><span class="n">target_col</span><span class="si">}</span><span class="s1"> - Split_fn = </span><span class="si">{</span><span class="n">split_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> - Drop source_ip/port = </span><span class="si">{</span><span class="n">drop_source_ip</span><span class="si">}</span><span class="s1"> - Drop destination ip/port = </span><span class="si">{</span><span class="n">drop_destination_ip</span><span class="si">}</span><span class="s1"> - Window = </span><span class="si">{</span><span class="n">trailing_w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="o">*</span><span class="mi">120</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># if trailing_w &gt; 0 and drop_destination_ip:</span>
                        <span class="c1">#     continue</span>
                        <span class="n">auc</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">bal_accuracy</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">feature_importances</span> <span class="o">=</span> <span class="n">run_full_pipeline</span><span class="p">(</span>
                            <span class="n">target_col</span><span class="p">,</span> <span class="n">split_fn</span><span class="o">=</span><span class="n">split_fn</span><span class="p">,</span>
                            <span class="n">features</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">FEATURES</span><span class="p">),</span>
                            <span class="n">lagged_features</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">LAGGED_FEATURES</span><span class="p">),</span>
                            <span class="n">drop_source_ip</span><span class="o">=</span><span class="n">drop_source_ip</span><span class="p">,</span>
                            <span class="n">drop_destination_ip</span><span class="o">=</span><span class="n">drop_destination_ip</span><span class="p">,</span>
                            <span class="n">trailing_window</span><span class="o">=</span><span class="n">trailing_w</span><span class="p">,</span>
                            <span class="n">train_verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">)</span>
                        <span class="n">trail</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target_col</span><span class="p">,</span>
                            <span class="s1">&#39;split_fn&#39;</span><span class="p">:</span> <span class="n">split_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                            <span class="s1">&#39;drop_source_ip&#39;</span><span class="p">:</span> <span class="n">drop_source_ip</span><span class="p">,</span>
                            <span class="s1">&#39;drop_destination_ip&#39;</span><span class="p">:</span> <span class="n">drop_destination_ip</span><span class="p">,</span>
                            <span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">trailing_w</span><span class="p">,</span>
                            <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span>
                            <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
                            <span class="s1">&#39;bal_accuracy&#39;</span><span class="p">:</span> <span class="n">bal_accuracy</span><span class="p">,</span>
                            <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">:</span> <span class="n">confusion_matrix</span><span class="p">,</span>
                            <span class="s1">&#39;classification_report&#39;</span><span class="p">:</span> <span class="n">classification_report</span><span class="p">,</span>
                            <span class="s1">&#39;feature_importances&#39;</span><span class="p">:</span> <span class="n">feature_importances</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">trials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trail</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># import traceback</span>
                        <span class="c1"># print(traceback.print_exc())</span>
                        <span class="c1"># raise e</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c1"># save experiment results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;reports/data/trial_results_n_trails_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Classification Report for blue_team - Split_fn = split_by_time - Drop source_ip/port = True - Drop destination ip/port = True - Window = 0
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Features:  [&#39;totDataBytes&#39;, &#39;client.bytes&#39;, &#39;server.bytes&#39;, &#39;network.packets&#39;, &#39;source.packets&#39;, &#39;destination.packets&#39;, &#39;network.bytes&#39;, &#39;source.bytes&#39;, &#39;destination.bytes&#39;, &#39;hour_sin&#39;, &#39;hour_cos&#39;, &#39;minute_sin&#39;, &#39;minute_cos&#39;, &#39;second_sin&#39;, &#39;second_cos&#39;, &#39;microsecond_sin&#39;, &#39;microsecond_cos&#39;, &#39;ipProtocol&#39;, &#39;protocol&#39;, &#39;source.geo.country_iso_code&#39;, &#39;destination.geo.country_iso_code&#39;, &#39;has_dns_host&#39;, &#39;has_cert&#39;]
Target Name:  blue_team
Train size: (61255, 23)
Val size: (6007, 23)
Test size: (60623, 23)
Total classes: 10, Classes: [&#39;Team 1&#39; &#39;Team 10&#39; &#39;Team 2&#39; &#39;Team 3&#39; &#39;Team 4&#39; &#39;Team 5&#39; &#39;Team 6&#39; &#39;Team 7&#39;
 &#39;Team 8&#39; &#39;Team 9&#39;]
AUC: 0.7679469573126809
Accuracy: 0.3056595681507019
Balance Accuracy: 0.31531123920315973
Confusion Matrix:
[[   47    63    35    89    88    77   107    88   153    97]
 [   37  4252   111   414   238   142   451    68   156    53]
 [  136   154  6302   152  1800  9649 12485   927   312    66]
 [   15    48    28   230   153    66   195    33   191    34]
 [   24    67   112    39  1456   146   554    68   108    63]
 [   40   285   254   136   603  3455  4051   656   477    47]
 [   18    90   241   151   324   127  1724   227   256    41]
 [   33    49   150    69   225    81   507   168   154    38]
 [   23    81    94   341   176   111   939   111   809    50]
 [   17    60    48   114    73    69   163   109    92    87]]
Classification Report:
              precision    recall  f1-score   support

      Team 1       0.12      0.06      0.08       844
     Team 10       0.83      0.72      0.77      5922
      Team 2       0.85      0.20      0.32     31983
      Team 3       0.13      0.23      0.17       993
      Team 4       0.28      0.55      0.37      2637
      Team 5       0.25      0.35      0.29     10004
      Team 6       0.08      0.54      0.14      3199
      Team 7       0.07      0.11      0.09      1474
      Team 8       0.30      0.30      0.30      2735
      Team 9       0.15      0.10      0.12       832

    accuracy                           0.31     60623
   macro avg       0.31      0.32      0.26     60623
weighted avg       0.61      0.31      0.34     60623

Feature important - Top 10 Features:
[(&#39;protocol&#39;, 0.12558153), (&#39;network.bytes&#39;, 0.0910334), (&#39;hour_cos&#39;, 0.08985384), (&#39;source.bytes&#39;, 0.08556776), (&#39;destination.bytes&#39;, 0.063546464), (&#39;minute_cos&#39;, 0.060563624), (&#39;client.bytes&#39;, 0.05158225), (&#39;network.packets&#39;, 0.048610274), (&#39;source.packets&#39;, 0.0473961), (&#39;hour_sin&#39;, 0.042673346)]
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Classification Report for blue_team - Split_fn = split_by_time - Drop source_ip/port = True - Drop destination ip/port = True - Window = 1
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Features:  [&#39;totDataBytes&#39;, &#39;client.bytes&#39;, &#39;server.bytes&#39;, &#39;network.packets&#39;, &#39;source.packets&#39;, &#39;destination.packets&#39;, &#39;network.bytes&#39;, &#39;source.bytes&#39;, &#39;destination.bytes&#39;, &#39;hour_sin&#39;, &#39;hour_cos&#39;, &#39;minute_sin&#39;, &#39;minute_cos&#39;, &#39;second_sin&#39;, &#39;second_cos&#39;, &#39;microsecond_sin&#39;, &#39;microsecond_cos&#39;, &#39;ipProtocol&#39;, &#39;protocol&#39;, &#39;source.geo.country_iso_code&#39;, &#39;destination.geo.country_iso_code&#39;, &#39;has_dns_host&#39;, &#39;has_cert&#39;, &#39;totDataBytes__lagged__1&#39;, &#39;client.bytes__lagged__1&#39;, &#39;server.bytes__lagged__1&#39;, &#39;network.packets__lagged__1&#39;, &#39;source.packets__lagged__1&#39;, &#39;destination.packets__lagged__1&#39;, &#39;network.bytes__lagged__1&#39;, &#39;source.bytes__lagged__1&#39;, &#39;destination.bytes__lagged__1&#39;, &#39;hour_sin__lagged__1&#39;, &#39;hour_cos__lagged__1&#39;, &#39;minute_sin__lagged__1&#39;, &#39;minute_cos__lagged__1&#39;, &#39;second_sin__lagged__1&#39;, &#39;second_cos__lagged__1&#39;, &#39;microsecond_sin__lagged__1&#39;, &#39;microsecond_cos__lagged__1&#39;, &#39;ipProtocol__lagged__1&#39;, &#39;protocol__lagged__1&#39;, &#39;source.geo.country_iso_code__lagged__1&#39;, &#39;destination.geo.country_iso_code__lagged__1&#39;, &#39;has_dns_host__lagged__1&#39;, &#39;has_cert__lagged__1&#39;]
Target Name:  blue_team
Train size: (61255, 46)
Val size: (6007, 46)
Test size: (60623, 46)
Total classes: 10, Classes: [&#39;Team 1&#39; &#39;Team 10&#39; &#39;Team 2&#39; &#39;Team 3&#39; &#39;Team 4&#39; &#39;Team 5&#39; &#39;Team 6&#39; &#39;Team 7&#39;
 &#39;Team 8&#39; &#39;Team 9&#39;]
AUC: 0.7889698422500827
Accuracy: 0.3755835244049288
Balance Accuracy: 0.3468024801706446
Confusion Matrix:
[[   78    31    29    99   128    63   107    60   176    73]
 [   27  4431    87   468   241    90   285   102   126    65]
 [   68    37  9143   143  1044  6163 12764  2368   195    58]
 [   18    23    29   238   144    60   203    45   196    37]
 [   21    31   104    90  1471   202   479    80   103    56]
 [  150   252   289   286  2102  4533  1771   335   248    38]
 [   16    42   353   137   335    79  1720   274   200    43]
 [   25    28   167    71   205    76   495   218   144    45]
 [   32    46    83   258   209    77   963   154   862    51]
 [   21    55    94    96    97    71   116   123    84    75]]
Classification Report:
              precision    recall  f1-score   support

      Team 1       0.17      0.09      0.12       844
     Team 10       0.89      0.75      0.81      5922
      Team 2       0.88      0.29      0.43     31983
      Team 3       0.13      0.24      0.17       993
      Team 4       0.25      0.56      0.34      2637
      Team 5       0.40      0.45      0.42     10004
      Team 6       0.09      0.54      0.16      3199
      Team 7       0.06      0.15      0.08      1474
      Team 8       0.37      0.32      0.34      2735
      Team 9       0.14      0.09      0.11       832

    accuracy                           0.38     60623
   macro avg       0.34      0.35      0.30     60623
weighted avg       0.66      0.38      0.42     60623

Feature important - Top 10 Features:
[(&#39;protocol__lagged__1&#39;, 0.122844), (&#39;hour_cos&#39;, 0.05613751), (&#39;network.bytes__lagged__1&#39;, 0.055367153), (&#39;network.bytes&#39;, 0.050940868), (&#39;network.packets__lagged__1&#39;, 0.04544477), (&#39;source.bytes&#39;, 0.045076966), (&#39;protocol&#39;, 0.043939117), (&#39;minute_cos&#39;, 0.035686456), (&#39;client.bytes__lagged__1&#39;, 0.033655453), (&#39;source.packets__lagged__1&#39;, 0.029146774)]
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Classification Report for blue_team - Split_fn = split_by_time - Drop source_ip/port = True - Drop destination ip/port = True - Window = 10
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
</pre></div></div>
</div>
</section>
<section id="Hyper-Tunning-by-Optuna">
<h1>Hyper Tunning by Optuna<a class="headerlink" href="#Hyper-Tunning-by-Optuna" title="Link to this heading">#</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import optuna</span>

<span class="c1"># drop_source_ips = [False, True]</span>
<span class="c1"># split_fns = [&#39;split_by_time&#39;, &#39;split_by_row&#39;]</span>
<span class="c1"># target_cols = label_binary_cols + label_mulclass_cols</span>

<span class="c1"># def objective(trial: optuna.trial.Trial):</span>
<span class="c1">#     target_col = trial.suggest_categorical(&#39;target&#39;, target_cols)</span>
<span class="c1">#     split_fn = trial.suggest_categorical(&#39;train_test_split_fn&#39;, split_fns)</span>
<span class="c1">#     split_fn = globals()[split_fn]</span>
<span class="c1">#     drop_source_ip = trial.suggest_categorical(&#39;drop_source_ip_port&#39;, drop_source_ips)</span>
<span class="c1">#     try:</span>
<span class="c1">#         auc, accuracy, bal_accuracy, confusion_matrix, classification_report, feature_importances = run_full_pipeline(target_col, split_fn=split_fn, drop_source_ip=drop_source_ip, train_verbose=False, print_result=True)</span>
<span class="c1">#         trial.set_user_attr(&#39;AUC&#39;, auc)</span>
<span class="c1">#         trial.set_user_attr(&#39;ACCURACY&#39;, accuracy)</span>
<span class="c1">#         trial.set_user_attr(&quot;BAL_ACC&quot;, bal_accuracy)</span>
<span class="c1">#         trial.set_user_attr(&quot;CONFUSION_MATRIX&quot;, str(confusion_matrix))</span>
<span class="c1">#         trial.set_user_attr(&quot;CLASSIFICATION_REPORT&quot;, classification_report)</span>
<span class="c1">#         trial.set_user_attr(&quot;FEATURE_IMPORTANCES&quot;, feature_importances)</span>
<span class="c1">#     except Exception as e:</span>
<span class="c1">#         print(e)</span>
<span class="c1">#         trial.set_user_attr(&quot;EXCEPTION&quot;, str(e))</span>
<span class="c1">#         return 0</span>
<span class="c1">#     return auc</span>

<span class="c1"># study = optuna.create_study(storage=&quot;sqlite:///db/ncdc_xgboost.sqlite3&quot;, study_name=&#39;ncdc_xgboost&#39;, load_if_exists=True, direction=&#39;maximize&#39;)</span>
<span class="c1"># study.optimize(objective, n_trials=None)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # fixing results</span>
<span class="c1"># log_file = &#39;reports/ncdc_xgboost_full_add_lags.log&#39;</span>
<span class="c1"># with open(&#39;reports/data/trial_results_n_trails_240_cpu-08_2023_04_22_21_19_51.pkl&#39;, &#39;rb&#39;) as fp:</span>
<span class="c1">#     df = pickle.load(fp)</span>

<span class="c1"># drop_source_ips = [False, True]</span>
<span class="c1"># drop_destination_ips = [False, True]</span>
<span class="c1"># split_fns = [&#39;split_by_time&#39;, &#39;split_by_row&#39;]</span>
<span class="c1"># target_cols = label_binary_cols + label_multi_classes_cols</span>
<span class="c1"># trailing_window_sizes = [0, 1, 5, 10]</span>


<span class="c1"># template = f&#39;Classification Report for {target_col} - Split_fn = {split_fn} - Drop source_ip/port = {drop_source_ip} - Drop destination ip/port = {drop_destination_ip} - Window = {trailing_w}&#39;</span>

<span class="c1"># trials = []</span>
<span class="c1"># df[&#39;window&#39;] = 0</span>
<span class="c1"># with open(log_file, &#39;r&#39;) as fp:</span>
<span class="c1">#     lines = fp.read().splitlines()</span>
<span class="c1">#     for target_col in target_cols:</span>
<span class="c1">#         for drop_source_ip in drop_source_ips:</span>
<span class="c1">#             for drop_destination_ip in drop_destination_ips:</span>
<span class="c1">#                 for split_fn in split_fns:</span>
<span class="c1">#                     windows = []</span>
<span class="c1">#                     for trailing_w in trailing_window_sizes:</span>
<span class="c1">#                         if trailing_w &gt; 0 and drop_destination_ip:</span>
<span class="c1">#                             continue</span>
<span class="c1">#                         template = f&#39;Classification Report for {target_col} - Split_fn = {split_fn} - Drop source_ip/port = {drop_source_ip} - Drop destination ip/port = {drop_destination_ip} - Window = {trailing_w}&#39;</span>
<span class="c1">#                         for line in lines:</span>
<span class="c1">#                             if line == template:</span>
<span class="c1">#                                 # ic(trailing_w, line.removesuffix(&#39;\n&#39;))</span>
<span class="c1">#                                 windows.append(trailing_w)</span>
<span class="c1">#                     if windows:</span>
<span class="c1">#                         # ic(windows)</span>
<span class="c1">#                         mask = (df[&#39;target&#39;] == target_col) &amp; (df[&#39;split_fn&#39;]==split_fn) &amp; (df[&#39;drop_source_ip&#39;] == drop_source_ip) &amp; (df[&#39;drop_destination_ip&#39;] == drop_destination_ip)</span>
<span class="c1">#                         # ic(df[mask][&#39;window&#39;].shape, len(windows))</span>
<span class="c1">#                         df.loc[mask, [&#39;window&#39;]] = windows</span>

<span class="c1"># import pickle</span>
<span class="c1"># pickle.dump(df, open(&#39;reports/data/trial_results_n_trails_240_cpu-08_2023_04_22_21_19_51_fixed_windows.pkl&#39;, &#39;wb&#39;))</span>
</pre></div>
</div>
</div>
</section>
<section id="Analysize-Results">
<h1>Analysize Results<a class="headerlink" href="#Analysize-Results" title="Link to this heading">#</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="c1"># with open(&#39;reports/data/trial_results_n_trails_240_cpu-08_2023_04_22_21_19_51_fixed_windows.pkl&#39;, &#39;rb&#39;) as fp:</span>
<span class="c1"># with open(&#39;reports/data/trial_results_n_trails_240_cpu-08_2023_04_22_21_19_51.pkl&#39;, &#39;rb&#39;) as fp:</span>
<span class="c1"># with open(&#39;reports/data/trial_results_n_trails_28_cpu-02_2023_04_26_21_12_25.pkl&#39;, &#39;rb&#39;) as fp:</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;reports/data/trial_results_n_trails_28_NVD4K9M6K4_2023_05_02_12_48_53.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

<span class="n">str_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">,</span> <span class="s1">&#39;classification_report&#39;</span><span class="p">,</span> <span class="s1">&#39;feature_importances&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">str_cols</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">float_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">,</span> <span class="s1">&#39;bal_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">float_cols</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>target</th>
      <th>split_fn</th>
      <th>drop_source_ip</th>
      <th>drop_destination_ip</th>
      <th>window</th>
      <th>auc</th>
      <th>accuracy</th>
      <th>bal_accuracy</th>
      <th>confusion_matrix</th>
      <th>classification_report</th>
      <th>feature_importances</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>blue_team</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>0.76</td>
      <td>0.49</td>
      <td>0.32</td>
      <td>[[   66    26    63    73   100    60   116   ...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('protocol', 0.12349972), ('network.bytes', 0...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>blue_team</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>1</td>
      <td>0.79</td>
      <td>0.54</td>
      <td>0.35</td>
      <td>[[   56    11    85    72   147    90   111   ...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('protocol__lagged__1', 0.11651987), ('hour_c...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>blue_team</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>10</td>
      <td>0.80</td>
      <td>0.57</td>
      <td>0.36</td>
      <td>[[   82    28    78    62   149    95   116   ...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('protocol__lagged__10', 0.037768282), ('dest...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>blue_team</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>20</td>
      <td>0.80</td>
      <td>0.59</td>
      <td>0.37</td>
      <td>[[   59    17    97    59   162   123    86   ...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('protocol__lagged__16', 0.050368007), ('dest...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>facility</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>0.97</td>
      <td>0.90</td>
      <td>0.69</td>
      <td>[[   706     70     11]\n [     1 155149     4...</td>
      <td>precision    recall...</td>
      <td>[('source.bytes', 0.12454854), ('destination.b...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>facility</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>1</td>
      <td>0.97</td>
      <td>0.91</td>
      <td>0.73</td>
      <td>[[   730     55      2]\n [     3 155130     5...</td>
      <td>precision    recall...</td>
      <td>[('server.bytes__lagged__1', 0.18684399), ('ho...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>facility</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>10</td>
      <td>0.94</td>
      <td>0.91</td>
      <td>0.72</td>
      <td>[[   728     58      1]\n [     2 154960    23...</td>
      <td>precision    recall...</td>
      <td>[('server.bytes__lagged__2', 0.07993748), ('se...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>facility</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>20</td>
      <td>0.93</td>
      <td>0.91</td>
      <td>0.71</td>
      <td>[[   743     43      1]\n [     3 154955    23...</td>
      <td>precision    recall...</td>
      <td>[('server.bytes__lagged__9', 0.09269878), ('se...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>service</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>0.86</td>
      <td>0.75</td>
      <td>0.31</td>
      <td>[[   486      5      1      0      0      1   ...</td>
      <td>precision    recall  f1-scor...</td>
      <td>[('hour_sin', 0.3071031), ('source.bytes', 0.1...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>service</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>1</td>
      <td>0.87</td>
      <td>0.75</td>
      <td>0.32</td>
      <td>[[    31      2      2      0      0      4   ...</td>
      <td>precision    recall  f1-scor...</td>
      <td>[('hour_sin', 0.26280984), ('totDataBytes__lag...</td>
    </tr>
    <tr>
      <th>10</th>
      <td>service</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>10</td>
      <td>0.87</td>
      <td>0.76</td>
      <td>0.34</td>
      <td>[[   344      4      0      0      0      2   ...</td>
      <td>precision    recall  f1-scor...</td>
      <td>[('hour_sin', 0.11766009), ('totDataBytes__lag...</td>
    </tr>
    <tr>
      <th>11</th>
      <td>service</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>20</td>
      <td>0.87</td>
      <td>0.75</td>
      <td>0.34</td>
      <td>[[   295      3      0      0      0      1   ...</td>
      <td>precision    recall  f1-scor...</td>
      <td>[('hour_sin', 0.07631924), ('server.bytes__lag...</td>
    </tr>
    <tr>
      <th>12</th>
      <td>hostname</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>0.84</td>
      <td>0.39</td>
      <td>0.32</td>
      <td>[[6606    7   20 1832   32  598    3  689    2...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('source.bytes', 0.2546319), ('hour_cos', 0.2...</td>
    </tr>
    <tr>
      <th>13</th>
      <td>hostname</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>1</td>
      <td>0.85</td>
      <td>0.38</td>
      <td>0.33</td>
      <td>[[5139    6   22 3993   71    6    0  588    6...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('hour_cos', 0.21176082), ('source.bytes', 0....</td>
    </tr>
    <tr>
      <th>14</th>
      <td>hostname</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>10</td>
      <td>0.86</td>
      <td>0.38</td>
      <td>0.34</td>
      <td>[[5644    6   20 2368  183    6    0 1580    7...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('protocol__lagged__10', 0.13269606), ('hour_...</td>
    </tr>
    <tr>
      <th>15</th>
      <td>hostname</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>20</td>
      <td>0.86</td>
      <td>0.39</td>
      <td>0.36</td>
      <td>[[5847    8   20 2592   67   30    0 1210    7...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('protocol__lagged__19', 0.15178029), ('totDa...</td>
    </tr>
    <tr>
      <th>16</th>
      <td>dns_alias</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>0.93</td>
      <td>0.54</td>
      <td>0.68</td>
      <td>[[9303  550    9]\n [ 255 1451   16]\n [9054 2...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('source.bytes', 0.3727405), ('hour_cos', 0.3...</td>
    </tr>
    <tr>
      <th>17</th>
      <td>dns_alias</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>1</td>
      <td>0.89</td>
      <td>0.54</td>
      <td>0.68</td>
      <td>[[9300  314  248]\n [ 204 1475   43]\n [2482 9...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('hour_cos', 0.3120932), ('source.bytes', 0.2...</td>
    </tr>
    <tr>
      <th>18</th>
      <td>dns_alias</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>10</td>
      <td>0.90</td>
      <td>0.58</td>
      <td>0.66</td>
      <td>[[9028  601  233]\n [ 430 1244   48]\n [2736 7...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('hour_cos', 0.15336676), ('source.bytes', 0....</td>
    </tr>
    <tr>
      <th>19</th>
      <td>dns_alias</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>20</td>
      <td>0.93</td>
      <td>0.71</td>
      <td>0.75</td>
      <td>[[9163  570  129]\n [ 394 1290   38]\n [1957 4...</td>
      <td>precision    recall  f1-score   ...</td>
      <td>[('destination.bytes__lagged__20', 0.2085979),...</td>
    </tr>
    <tr>
      <th>20</th>
      <td>hardware</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>0.79</td>
      <td>0.49</td>
      <td>0.40</td>
      <td>[[  920  1093    15    30  6947   359]\n [   2...</td>
      <td>precision    recall  f1-...</td>
      <td>[('source.bytes', 0.16471986), ('hour_cos', 0....</td>
    </tr>
    <tr>
      <th>21</th>
      <td>hardware</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>1</td>
      <td>0.82</td>
      <td>0.49</td>
      <td>0.42</td>
      <td>[[  915  2947    10    41  5081   370]\n [    ...</td>
      <td>precision    recall  f1-...</td>
      <td>[('server.bytes__lagged__1', 0.2979786), ('hou...</td>
    </tr>
    <tr>
      <th>22</th>
      <td>hardware</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>10</td>
      <td>0.80</td>
      <td>0.54</td>
      <td>0.44</td>
      <td>[[ 1216   641     5    38  7219   245]\n [   3...</td>
      <td>precision    recall  f1-...</td>
      <td>[('server.bytes__lagged__2', 0.22137028), ('se...</td>
    </tr>
    <tr>
      <th>23</th>
      <td>hardware</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>20</td>
      <td>0.83</td>
      <td>0.53</td>
      <td>0.43</td>
      <td>[[ 1202  1168     1    23  6675   295]\n [   2...</td>
      <td>precision    recall  f1-...</td>
      <td>[('server.bytes__lagged__2', 0.19332004), ('pr...</td>
    </tr>
    <tr>
      <th>24</th>
      <td>opsys</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>0</td>
      <td>0.86</td>
      <td>0.45</td>
      <td>0.39</td>
      <td>[[   0    0    0    0    0    0    0    0    0...</td>
      <td>precision    recall  f1-s...</td>
      <td>[('source.bytes', 0.25220183), ('hour_cos', 0....</td>
    </tr>
    <tr>
      <th>25</th>
      <td>opsys</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>1</td>
      <td>0.88</td>
      <td>0.49</td>
      <td>0.42</td>
      <td>[[   0    1    0    0    0    2    1    0    0...</td>
      <td>precision    recall  f1-s...</td>
      <td>[('hour_cos', 0.18142836), ('source.bytes', 0....</td>
    </tr>
    <tr>
      <th>26</th>
      <td>opsys</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>10</td>
      <td>0.87</td>
      <td>0.42</td>
      <td>0.40</td>
      <td>[[   0    1    0    0    0    2    3    0    0...</td>
      <td>precision    recall  f1-s...</td>
      <td>[('protocol__lagged__10', 0.13177043), ('totDa...</td>
    </tr>
    <tr>
      <th>27</th>
      <td>opsys</td>
      <td>split_by_time</td>
      <td>True</td>
      <td>True</td>
      <td>20</td>
      <td>0.88</td>
      <td>0.45</td>
      <td>0.42</td>
      <td>[[   0    1    0    0    0    2    1    0    0...</td>
      <td>precision    recall  f1-s...</td>
      <td>[('protocol__lagged__20', 0.12444028), ('totDa...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="c1"># fig = px.parallel_coordinates(</span>
<span class="n">objective</span> <span class="o">=</span> <span class="s1">&#39;auc&#39;</span>
<span class="c1"># objective = &#39;bal_accuracy&#39;</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">parallel_categories</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span>
    <span class="c1"># df[df[&#39;drop_destination_ip&#39;]==False],</span>
    <span class="c1"># df[</span>
    <span class="c1">#     (df[&#39;target&#39;].isin({&#39;service&#39;, &#39;hostname&#39;, &#39;hardware&#39;, &#39;opsys&#39;}))</span>
    <span class="c1">#     &amp; (df[&#39;drop_destination_ip&#39;]==False)</span>
    <span class="c1">#     &amp; (df[&#39;drop_source_ip&#39;]==True)</span>
    <span class="c1">#     &amp; (df[&#39;split_fn&#39;] == &#39;split_by_time&#39;)</span>
    <span class="c1"># ],</span>
    <span class="n">color</span><span class="o">=</span><span class="n">objective</span><span class="p">,</span>
    <span class="n">dimensions</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;split_fn&#39;,</span>
        <span class="c1"># &#39;drop_source_ip&#39;,</span>
        <span class="c1"># &#39;drop_destination_ip&#39;,</span>
        <span class="s1">&#39;window&#39;</span><span class="p">,</span>
        <span class="c1"># objective,</span>
    <span class="p">],</span>
    <span class="n">color_continuous_scale</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">diverging</span><span class="o">.</span><span class="n">Tealrose</span><span class="p">,</span>
    <span class="c1"># color_continuous_midpoint=0.5,</span>
    <span class="c1"># dimensions_max_cardinality=5,</span>

<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="admonition warning">
<p>Data type cannot be displayed: application/vnd.plotly.v1+json</p>
</div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fig.write_html(&#39;reports/parallel_categories_iternative_chart_multi_classes_target_vs_windows.html&#39;)</span>
</pre></div>
</div>
</div>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, AI - Applied Artificial Intelligence Institute, Deakin University
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/js/mermaid.min.js?v=14bd7125"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    </body>
</html>